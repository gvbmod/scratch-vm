// Name: Canvas Effects
// ID: theshovelcanvaseffects
// Description: Apply visual effects to the entire stage.
// By: TheShovel
// By: SharkPool <https://scratch.mit.edu/users/DemonX5/>
// License: MIT

/* generated l10n code */Scratch.translate.setup({"de":{"_Canvas Effects":"Bühneneffekte"},"fi":{"_Canvas Effects":"Canvas-tehosteet","_background":"tausta","_blur":"sumennus","_border color":"reunuksen väri","_border radius":"reunuksen säde","_border style":"reunuksen tyyli","_border width":"reunuksen leveys","_brightness":"kirkkaus","_change canvas [EFFECT] by [NUMBER]":"lisää canvas-tehostetta [EFFECT] arvolla [NUMBER]","_color shift":"värinvaihto","_contrast":"kontrasti","_dashed":"viivoja","_default":"oletus","_dotted":"pisteitä","_double":"kaksoisviivaa","_get canvas [EFFECT]":"canvas-tehoste [EFFECT]","_groove":"ulkoista sisäkkäistä viivaa","_inset":"ylä-vasenta viivaa","_invert":"käänteiset värit","_none":"ilman kuviota","_offset X":"x-siirto","_offset Y":"y-siirto","_outset":"ala-oikeaa viivaa","_pixelated":"pikselöinti","_resize rendering mode":"renderöintitila","_ridge":"sisäistä sisäkkäistä viivaa","_rotation":"kierto","_saturation":"värikylläisyys","_scale":"skaalaus","_scale X":"x-skaalaus","_scale Y":"y-skaalaus","_sepia":"seepia","_set canvas [EFFECT] to [NUMBER]":"aseta canvas-tehoste [EFFECT] arvoon [NUMBER]","_set canvas border to [WIDTH] pixels [STYLE] with color [COLOR1] and background [COLOR2]":"aseta canvas-elementin reunukseksi [WIDTH] pikseliä [STYLE] värillä [COLOR1] ja taustalla [COLOR2]","_set canvas render size to width: [X] height: [Y]":"aseta canvas-elementin kooksi leveys: [X] korkeus: [Y]","_set canvas resize rendering mode [EFFECT]":"aseta canvas-elementin renderöintitilaksi [EFFECT]","_skew X":"x-vinous","_skew Y":"y-vinous","_solid":"tasaista viivaa","_transparency":"läpinäkyvyys"},"it":{"_Canvas Effects":"Effetti Stage","_scale":"scala"},"ja":{"_brightness":"明るさ","_scale":"スケール"},"ko":{"_Canvas Effects":"Canvas 효과","_border color":"외곽선 색상","_border radius":"외곽선 둥글기","_border style":"외곽선 스타일","_border width":"외곽선 두께","_brightness":"밝기","_change canvas [EFFECT] by [NUMBER]":"캔버스 [EFFECT]을(를) [NUMBER]만큼 바꾸기","_default":"기본","_invert":"반전","_sepia":"세피아","_set canvas [EFFECT] to [NUMBER]":"캔버스 [EFFECT]을(를) [NUMBER](으)로 정하기"},"nb":{"_Canvas Effects":"Canvas effekter","_brightness":"lysstyrke","_scale":"skala"},"nl":{"_Canvas Effects":"Canvas-effecten","_background":"randachtergrond","_blur":"vervaging","_border color":"randkleur","_border radius":"randstraal","_border style":"randstijl","_border width":"randbreedte","_brightness":"helderheid","_change canvas [EFFECT] by [NUMBER]":"verander canvas-effect [EFFECT] met [NUMBER]","_color shift":"kleurverschuiving","_dashed":"onderbroken","_default":"standaard","_dotted":"gestippeld","_double":"dubbel","_get canvas [EFFECT]":"canvas-effect [EFFECT]","_groove":"groef","_inset":"ingesprongen","_invert":"omgekeerd","_none":"geen","_offset X":"x-verschuiving","_offset Y":"y-verschuiving","_outset":"uitstekend","_pixelated":"gepixeleerd","_resize rendering mode":"formaatverandering-rendermodus","_ridge":"richel","_rotation":"rotatie","_saturation":"verzadiging","_scale":"schaal","_scale X":"x-schaal","_scale Y":"y-schaal","_set canvas [EFFECT] to [NUMBER]":"zet canvas-effect [EFFECT] op [NUMBER]","_set canvas border to [WIDTH] pixels [STYLE] with color [COLOR1] and background [COLOR2]":"zet canvas-rand op [WIDTH] pixels [STYLE] met kleur [COLOR1] en achtergrond [COLOR2]","_set canvas render size to width: [X] height: [Y]":"zet canvas-rendergrootte op: breedte: [X] hoogte: [Y]","_set canvas resize rendering mode [EFFECT]":"zet formaatverandering-rendermodus van canvas op [EFFECT]","_skew X":"x-scheefheid","_skew Y":"y-scheefheid","_solid":"ononderbroken","_transparency":"doorzichtigheid"},"pl":{"_brightness":"jasność","_saturation":"nasycenie","_scale":"skala","_transparency":"przezroczystość"},"ru":{"_Canvas Effects":"Canvas Эффекты","_background":"задний фон","_blur":"блюр","_border color":"цвет барьера","_border radius":"радиус барьера","_border style":"стиль барьера","_border width":"ширина барьера","_brightness":"яркость","_change canvas [EFFECT] by [NUMBER]":"изменить [EFFECT] холст в [NUMBER]","_color shift":"изменение цвета","_contrast":"контраст","_dashed":"дэшнутый","_default":"по умолчанию","_dotted":"пунктирный","_double":"двойной","_get canvas [EFFECT]":"получить [EFFECT] холст","_groove":"граффити","_inset":"врезанный","_invert":"инверт","_none":"никакой","_offset X":"смещение X","_offset Y":"смещение Y","_outset":"разрезанный","_pixelated":"пикселизированный","_resize rendering mode":"режим рендеринга с изменением размера","_ridge":"ребро","_rotation":"поворот","_saturation":"насыщенный","_scale":"размер","_scale X":"размер X","_scale Y":"размер Y","_sepia":"сепия","_set canvas [EFFECT] to [NUMBER]":"задать [EFFECT] холст в [NUMBER]","_set canvas border to [WIDTH] pixels [STYLE] with color [COLOR1] and background [COLOR2]":"задать барьер холста на [WIDTH] пикселей [STYLE] с цветом [COLOR1] и задним фоном [COLOR2]","_set canvas render size to width: [X] height: [Y]":"задать размер рендера холста на ширину: [X] высоту: [Y]","_set canvas resize rendering mode [EFFECT]":"установить режим рендеринга с изменением размера холста [EFFECT]","_skew X":"скос X","_skew Y":"скос Y","_solid":"твёрдый","_transparency":"прозрачность"},"tr":{"_Canvas Effects":"Tuval Efektleri"},"zh-cn":{"_Canvas Effects":"Canvas 特效","_background":"背景","_blur":"模糊","_border color":"边缘颜色","_border radius":"边缘半径","_border style":"边缘样式","_border width":"边缘宽","_brightness":"亮度","_change canvas [EFFECT] by [NUMBER]":"将画布[EFFECT]增加[NUMBER]","_color shift":"颜色偏移","_contrast":"对比度","_dashed":"虚线","_default":"默认类型","_dotted":"点状","_double":"双线","_get canvas [EFFECT]":"获取画布[EFFECT]","_groove":"凹槽","_inset":"嵌入","_invert":"反色","_none":"无","_offset X":"X 偏移","_offset Y":"Y 偏移","_outset":"外凸","_pixelated":"像素化","_resize rendering mode":"重设尺寸时的渲染模式","_ridge":"垄状","_rotation":"旋转","_saturation":"饱和度","_scale":"规模","_scale X":"X 缩放","_scale Y":"Y 缩放","_sepia":"深褐色","_set canvas [EFFECT] to [NUMBER]":"设置画布[EFFECT]为[NUMBER]","_set canvas border to [WIDTH] pixels [STYLE] with color [COLOR1] and background [COLOR2]":"将画布边框设置为[WIDTH]像素[STYLE]样式，颜色为[COLOR1]背景颜色为[COLOR2]","_set canvas render size to width: [X] height: [Y]":"设置画布渲染尺寸为宽:[X]高:[Y]","_set canvas resize rendering mode [EFFECT]":"设置画布重设尺寸渲染模式为[EFFECT]","_skew X":"X 倾斜","_skew Y":"Y 倾斜","_solid":"实线","_transparency":"透明度"}});/* end generated l10n code */(function (Scratch) {
  "use strict";
  if (!Scratch.extensions.unsandboxed) {
    throw new Error("This extension must run unsandboxed");
  }

  const canvas = Scratch.renderer.canvas;

  const updateStyle = () => {
    // Gotta keep the translation to % because of the stage size, window size and so on
    const transform = `rotate(${rotation}deg) scale(${scaleX}%, ${scaleY}%) skew(${skewX}deg, ${skewY}deg) translate(${offsetX}%, ${
      0 - offsetY
    }%)`;
    if (canvas.style.transform !== transform) {
      canvas.style.transform = transform;
    }
    const filter = `blur(${blur}px) contrast(${
      contrast / 100
    }) saturate(${saturation}%) hue-rotate(${color}deg) brightness(${brightness}%) invert(${invert}%) sepia(${sepia}%) opacity(${
      100 - transparency
    }%)`;
    if (canvas.style.filter !== filter) {
      canvas.style.filter = filter;
    }

    const cssBorderRadius = borderRadius === 0 ? "" : `${borderRadius}%`;
    if (canvas.style.borderRadius !== cssBorderRadius) {
      canvas.style.borderRadius = cssBorderRadius;
    }

    const imageRendering = resizeMode === "pixelated" ? "pixelated" : "";
    if (canvas.style.imageRendering !== imageRendering) {
      canvas.style.imageRendering = imageRendering;
    }

    const border = `${borderWidth}px ${borderStyle} ${borderColor}`;
    if (canvas.style.border !== border) {
      canvas.style.border = border;
    }

    if (canvas.style.backgroundColor !== backgroundColor) {
      canvas.style.backgroundColor = backgroundColor;
    }
  };

  // scratch-gui may reset canvas styles when resizing the window or going in/out of fullscreen
  new MutationObserver(updateStyle).observe(canvas, {
    attributeFilter: ["style"],
    attributes: true,
  });

  let borderRadius = 0;
  let rotation = 0;
  let offsetY = 0;
  let offsetX = 0;
  let skewY = 0;
  let skewX = 0;
  let scaleX = 100;
  let scaleY = 100;
  // Thanks SharkPool for telling me about these
  let transparency = 0;
  let sepia = 0;
  let blur = 0;
  let contrast = 100;
  let saturation = 100;
  let color = 0;
  let brightness = 100;
  let invert = 0;
  let resizeMode = "default";
  let borderStyle = "solid";
  let borderWidth = 0;
  let borderColor = "#000000";
  let backgroundColor = "transparent";

  const resetStyles = () => {
    borderRadius = 0;
    rotation = 0;
    offsetY = 0;
    offsetX = 0;
    skewY = 0;
    skewX = 0;
    scaleX = 100;
    scaleY = 100;
    transparency = 0;
    sepia = 0;
    blur = 0;
    contrast = 100;
    saturation = 100;
    color = 0;
    brightness = 100;
    invert = 0;
    resizeMode = "default";
    borderStyle = "solid";
    borderWidth = 0;
    borderColor = "#000000";
    backgroundColor = "transparent";
    updateStyle();
  };

  Scratch.vm.runtime.on("RUNTIME_DISPOSED", resetStyles);

  class CanvasEffects {
    getInfo() {
      return {
        id: "theshovelcanvaseffects",
        name: Scratch.translate("Canvas Effects"),
        blocks: [
          {
            opcode: "seteffect",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("set canvas [EFFECT] to [NUMBER]"),
            arguments: {
              EFFECT: {
                type: Scratch.ArgumentType.STRING,
                menu: "EFFECTMENU",
              },
              NUMBER: {
                type: Scratch.ArgumentType.NUMBER,
              },
            },
          },
          {
            opcode: "changeEffect",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate("change canvas [EFFECT] by [NUMBER]"),
            arguments: {
              EFFECT: {
                type: Scratch.ArgumentType.STRING,
                menu: "EFFECTMENU",
              },
              NUMBER: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 5,
              },
            },
          },
          {
            opcode: "geteffect",
            blockType: Scratch.BlockType.REPORTER,
            text: Scratch.translate("get canvas [EFFECT]"),
            arguments: {
              EFFECT: {
                type: Scratch.ArgumentType.STRING,
                menu: "EFFECTGETMENU",
              },
            },
          },
          {
            opcode: "cleareffects",
            blockType: Scratch.BlockType.COMMAND,
            text: "clear canvas effects",
          },
          "---",
          {
            opcode: "setBorder",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate(
              "set canvas border to [WIDTH] pixels [STYLE] with color [COLOR1] and background [COLOR2]"
            ),
            arguments: {
              STYLE: {
                type: Scratch.ArgumentType.STRING,
                menu: "borderTypes",
              },
              WIDTH: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 5,
              },
              COLOR1: {
                type: Scratch.ArgumentType.COLOR,
                defaultValue: "#ff0000",
              },
              COLOR2: {
                type: Scratch.ArgumentType.COLOR,
                defaultValue: "#0000ff",
              },
            },
          },
          {
            opcode: "renderscale",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate(
              "set canvas render size to width: [X] height: [Y]"
            ),
            arguments: {
              X: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 100,
              },
              Y: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 100,
              },
            },
          },
          {
            opcode: "setrendermode",
            blockType: Scratch.BlockType.COMMAND,
            text: Scratch.translate(
              "set canvas resize rendering mode [EFFECT]"
            ),
            arguments: {
              EFFECT: {
                type: Scratch.ArgumentType.STRING,
                menu: "RENDERMODE",
              },
            },
          },
        ],
        menus: {
          EFFECTMENU: {
            acceptReporters: true,
            items: this._getMenuItems(false),
          },
          RENDERMODE: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate("pixelated"),
                value: "pixelated",
              },
              {
                text: Scratch.translate("default"),
                value: "default",
              },
            ],
          },
          EFFECTGETMENU: {
            acceptReporters: true,
            items: this._getMenuItems(true),
          },
          borderTypes: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate("dotted"),
                value: "dotted",
              },
              {
                text: Scratch.translate("dashed"),
                value: "dashed",
              },
              {
                text: Scratch.translate("solid"),
                value: "solid",
              },
              {
                text: Scratch.translate("double"),
                value: "double",
              },
              {
                text: Scratch.translate("groove"),
                value: "groove",
              },
              {
                text: Scratch.translate("ridge"),
                value: "ridge",
              },
              {
                text: Scratch.translate("inset"),
                value: "inset",
              },
              {
                text: Scratch.translate("outset"),
                value: "outset",
              },
              {
                text: Scratch.translate("none"),
                value: "none",
              },
            ],
          },
        },
      };
    }

    _getMenuItems(isGetter) {
      return [
        {
          text: Scratch.translate("blur"),
          value: "blur",
        },
        {
          text: Scratch.translate("contrast"),
          value: "contrast",
        },
        {
          text: Scratch.translate("saturation"),
          value: "saturation",
        },
        {
          text: Scratch.translate("color shift"),
          value: "color shift",
        },
        {
          text: Scratch.translate("brightness"),
          value: "brightness",
        },
        {
          text: Scratch.translate("invert"),
          value: "invert",
        },
        ...(isGetter
          ? [
              {
                text: Scratch.translate("resize rendering mode"),
                value: "resize rendering mode",
              },
            ]
          : []),
        {
          text: Scratch.translate("sepia"),
          value: "sepia",
        },
        {
          text: Scratch.translate("transparency"),
          value: "transparency",
        },
        ...(isGetter
          ? []
          : [
              {
                text: Scratch.translate({
                  default: "scale",
                  description: "Scale as in upscale/downscale",
                }),
                value: "scale",
              },
            ]),
        {
          text: Scratch.translate("scale X"),
          value: "scale X",
        },
        {
          text: Scratch.translate("scale Y"),
          value: "scale Y",
        },
        {
          text: Scratch.translate("skew X"),
          value: "skew X",
        },
        {
          text: Scratch.translate("skew Y"),
          value: "skew Y",
        },
        {
          text: Scratch.translate("offset X"),
          value: "offset X",
        },
        {
          text: Scratch.translate("offset Y"),
          value: "offset Y",
        },
        {
          text: Scratch.translate("rotation"),
          value: "rotation",
        },
        {
          text: Scratch.translate("border radius"),
          value: "border radius",
        },
        ...(isGetter
          ? [
              {
                text: Scratch.translate("border width"),
                value: "border width",
              },
              {
                text: Scratch.translate("border style"),
                value: "border style",
              },
              {
                text: Scratch.translate("border color"),
                value: "border color",
              },
              {
                text: Scratch.translate("background"),
                value: "background",
              },
            ]
          : []),
      ];
    }

    geteffect({ EFFECT }) {
      if (EFFECT === "blur") {
        return blur;
      } else if (EFFECT === "contrast") {
        return contrast;
      } else if (EFFECT === "saturation") {
        return saturation;
      } else if (EFFECT === "color shift") {
        return color;
      } else if (EFFECT === "brightness") {
        return brightness;
      } else if (EFFECT === "invert") {
        return invert;
      } else if (EFFECT === "resize rendering mode") {
        return resizeMode;
      } else if (EFFECT === "sepia") {
        return sepia;
      } else if (EFFECT === "transparency") {
        return transparency;
      } else if (EFFECT === "scale") {
        // old extension compatibility
        return scaleX;
      } else if (EFFECT === "scale X") {
        return scaleX;
      } else if (EFFECT === "scale Y") {
        return scaleY;
      } else if (EFFECT === "skew X") {
        return skewX;
      } else if (EFFECT === "skew Y") {
        return skewY;
      } else if (EFFECT === "offset X") {
        return offsetX;
      } else if (EFFECT === "offset Y") {
        return offsetY;
      } else if (EFFECT === "rotation") {
        return rotation;
      } else if (EFFECT === "border radius") {
        return borderRadius;
      } else if (EFFECT === "border width") {
        return borderWidth;
      } else if (EFFECT === "border style") {
        return borderStyle;
      } else if (EFFECT === "border color") {
        return borderColor;
      } else if (EFFECT === "background") {
        return backgroundColor;
      }
      return "";
    }
    seteffect({ EFFECT, NUMBER }) {
      NUMBER = Scratch.Cast.toNumber(NUMBER);
      if (EFFECT === "blur") {
        blur = NUMBER;
      } else if (EFFECT === "contrast") {
        contrast = NUMBER;
      } else if (EFFECT === "saturation") {
        saturation = NUMBER;
      } else if (EFFECT === "color shift") {
        color = NUMBER;
      } else if (EFFECT === "brightness") {
        brightness = NUMBER;
      } else if (EFFECT === "invert") {
        invert = NUMBER;
      } else if (EFFECT === "sepia") {
        sepia = NUMBER;
      } else if (EFFECT === "transparency") {
        transparency = NUMBER;
      } else if (EFFECT === "scale") {
        scaleX = NUMBER;
        scaleY = NUMBER;
      } else if (EFFECT === "scale X") {
        scaleX = NUMBER;
      } else if (EFFECT === "scale Y") {
        scaleY = NUMBER;
      } else if (EFFECT === "skew X") {
        skewX = NUMBER;
      } else if (EFFECT === "skew Y") {
        skewY = NUMBER;
      } else if (EFFECT === "offset X") {
        offsetX = NUMBER;
      } else if (EFFECT === "offset Y") {
        offsetY = NUMBER;
      } else if (EFFECT === "rotation") {
        rotation = NUMBER;
      } else if (EFFECT === "border radius") {
        borderRadius = NUMBER;
      }
      updateStyle();
    }
    changeEffect(args) {
      // Scale needs some special treatment to change x & y separately
      if (args.EFFECT === "scale") {
        scaleX = scaleX + Scratch.Cast.toNumber(args.NUMBER);
        scaleY = scaleY + Scratch.Cast.toNumber(args.NUMBER);
        updateStyle();
        return;
      }

      // Everything else is really generic
      const currentEffect = Scratch.Cast.toNumber(this.geteffect(args));
      const newValue = Scratch.Cast.toNumber(args.NUMBER) + currentEffect;
      this.seteffect({
        EFFECT: args.EFFECT,
        NUMBER: newValue,
      });
    }
    cleareffects() {
      resetStyles();
    }
    setrendermode({ EFFECT }) {
      resizeMode = EFFECT;
      updateStyle();
    }
    renderscale({ X, Y }) {
      Scratch.vm.renderer.resize(X, Y);
    }
    setBorder(args) {
      borderWidth = Scratch.Cast.toNumber(args.WIDTH);
      borderStyle = Scratch.Cast.toString(args.STYLE).replace(/[^a-z]/gi, "");
      borderColor = Scratch.Cast.toString(args.COLOR1).replace(
        /[^#0-9a-z]/gi,
        ""
      );
      backgroundColor = Scratch.Cast.toString(args.COLOR2).replace(
        /[^#0-9a-z]/gi,
        ""
      );
      updateStyle();
    }
  }
  Scratch.extensions.register(new CanvasEffects());
})(Scratch);
